<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Achievements | Notora</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://kit.fontawesome.com/1c020da525.js" crossorigin="anonymous"></script>
<style>
  :root{
    --bg:#0f0f10; --card:#141414; --accent:#ff4141; --muted:#9aa0a6;
  }
  body{
    margin:0;
    font-family:Poppins,system-ui;
    background:radial-gradient(circle at top, #0a0a0a, #000);
    color:#fff;
    padding:18px;
  }
  .container{max-width:1100px;margin:0 auto;}
  .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
  h1{margin:0;font-size:1.5rem;color:var(--accent)}
  .card-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:14px;margin-bottom:18px}
  .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.6);}
  .big-num{font-size:2rem;font-weight:700}
  .muted{color:var(--muted);font-size:0.9rem}
  .level-badge{display:flex;align-items:center;gap:8px;padding:8px;border-radius:10px;background:linear-gradient(90deg,rgba(255,65,108,0.06),transparent);border:1px solid rgba(255,65,108,0.06)}
  .progress{height:10px;background:#0b0b0b;border-radius:10px;overflow:hidden;margin-top:8px}
  .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#e50914);width:0%;transition:width 0.6s ease-in-out}
  .events{max-height:320px;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:8px}
  .event{display:flex;justify-content:space-between;gap:8px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);transition:0.3s}
  .event:hover{background:rgba(255,65,108,0.08);}
  .locked{display:flex;align-items:center;justify-content:center;padding:40px;border-radius:12px;background:linear-gradient(180deg,rgba(255,65,108,0.04),transparent);border:1px dashed rgba(255,65,108,0.06)}
  .btn{background:linear-gradient(135deg,var(--accent),#e50914);padding:8px 12px;border-radius:8px;border:none;color:#fff;cursor:pointer;transition:transform 0.3s}
  .btn:hover{transform:scale(1.05)}
  .nt{color:#ff4141;font-weight:700}
  @media(min-width:900px){ .header h1{font-size:1.7rem} }

  /* === Notora Footer === */
#nt-footer {
  background: linear-gradient(180deg, #0a0a0a 0%, #111 100%);
  color: #d1d5db;
  padding: 3rem 1.5rem 1rem;
  border-top: 2px solid #e50914;
  font-family: "Poppins", sans-serif;
  margin-top:15px;
}

.nt-footer-content {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 2.5rem;
  max-width: 1100px;
  margin: auto;
}

.nt-footer-logo {
  display: flex;
  align-items: center;
  gap: 10px;
}

.nt-footer-logo img {
  height: 45px;
}

.nt-footer-logo h2 {
  color: #fff;
  font-size: 1.8rem;
  margin: 0;
  font-weight: 700;
}

.nt-footer-logo h2 span {
  color: #e50914;
}

.nt-footer-desc {
  margin-top: 0.8rem;
  font-size: 0.95rem;
  line-height: 1.6;
  color: #b3b3b3;
}

.nt-footer-links h3,
.nt-footer-social h3 {
  color: #fff;
  font-size: 1.1rem;
  margin-bottom: 1rem;
  position: relative;
}

.nt-footer-links ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.nt-footer-links li {
  margin: 0.4rem 0;
}

.nt-footer-links a {
  color: #b3b3b3;
  text-decoration: none;
  transition: color 0.3s ease;
}

.nt-footer-links a:hover {
  color: #e50914;
}

.nt-footer-social {
  text-align: left;
}

.nt-social-icons {
  display: flex;
  gap: 1rem;
  font-size: 1.4rem;
  margin-bottom: 0.8rem;
}

.nt-social-icons a {
  color: #b3b3b3;
  transition: color 0.3s, transform 0.3s;
}

.nt-social-icons a:hover {
  color: #e50914;
  transform: scale(1.15);
}

.nt-footer-mail {
  font-size: 0.9rem;
  color: #aaa;
}

.nt-footer-bottom {
  border-top: 1px solid #2a2a2a;
  text-align: center;
  padding-top: 1rem;
  margin-top: 2rem;
  font-size: 0.85rem;
  color: #8b8b8b;
}


.nt-footer-links a:hover,
.nt-social-icons a:hover {
  text-shadow: 0 0 8px rgba(229, 9, 20, 0.7);
}
</style>
</head>
<body>
<div class="container" id="app">
  <div class="header">
    <h1><i class="fa-solid fa-medal" style="color:#ff4141"></i> Achievements & Rewards</h1>
    <div><button class="btn" id="goStore"><i class="fa-solid fa-store"></i> Store</button></div>
  </div>

  <div id="lockedNotice" style="display:none" class="locked">
    <div>
      <div style="font-weight:700;font-size:1.1rem">Login to unlock achievements</div>
      <div class="muted" style="margin-top:6px">Sign in to view your personal stats and Notora rewards.</div>
    </div>
  </div>

  <div id="content" style="display:none">
    <div class="card-grid">
      <div class="card">
        <div class="muted">Total Books Read</div>
        <div class="big-num" id="totalReads">0</div>
        <div class="muted">This month / week / today</div>
        <div style="display:flex;gap:6px;margin-top:8px">
          <div class="card" style="padding:8px;background:rgba(255,255,255,0.03);min-width:80px">
            <div class="muted">Month</div><div id="monthReads" class="big-num" style="font-size:1.2rem">0</div>
          </div>
          <div class="card" style="padding:8px;background:rgba(255,255,255,0.03);min-width:80px">
            <div class="muted">Week</div><div id="weekReads" class="big-num" style="font-size:1.2rem">0</div>
          </div>
          <div class="card" style="padding:8px;background:rgba(255,255,255,0.03);min-width:80px">
            <div class="muted">Today</div><div id="todayReads" class="big-num" style="font-size:1.2rem">0</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="muted">Your Balance</div>
        <div class="big-num"><i class="fa-solid fa-coins" style="color:#ff4141"></i> <span id="points">0</span><span class="nt"> NT</span></div>
        <div class="muted" style="margin-top:8px">Earn: +1NT (read) â€¢ +2NT (share) â€¢ +5NT (donate)</div>
      </div>

      <div class="card">
        <div class="muted">Level Progress</div>
        <div class="level-badge">
          <div style="font-size:1.3rem;font-weight:700" id="levelLabel">Lv 0</div>
          <div class="muted" id="levelDesc">Newbie</div>
        </div>
        <div class="progress" style="margin-top:8px"><i id="levelProgress"></i></div>
      </div>

      <div class="card">
        <div class="muted">Last Active</div>
        <div id="lastActive" class="muted">â€”</div>
        <div style="margin-top:12px"><button class="btn" id="refreshBtn"><i class="fa-solid fa-rotate-right"></i> Refresh</button></div>
      </div>
    </div>

    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <div style="flex:1;min-width:320px" class="card">
        <div class="muted"><i class="fa-solid fa-clock-rotate-left"></i> Recent Activity</div>
        <div class="events" id="events"></div>
      </div>

      <div style="width:320px" class="card">
        <div class="muted"><i class="fa-solid fa-gift"></i> Store (Preview)</div>
        <div style="margin-top:10px">Exchange your NT points for Notora rewards and perks.</div>
        <div style="margin-top:12px"><button class="btn" id="openStore"><i class="fa-solid fa-bag-shopping"></i> Open Store</button></div>
      </div>
    </div>
  </div>
</div>

   <footer id="nt-footer">
  <div class="nt-footer-content">
    <div class="nt-footer-left">
      <div class="nt-footer-logo">
        <img src="Lucid_Realism_Create_a_modern_flat_educational_logo_with_the_b_1.png" alt="Notora Logo">
        <h2><span></span> Notora</h2>
      </div>
      <p class="nt-footer-desc">
        A collaborative platform dedicated to accessible and open education.<br>
        Empowering readers to <strong>share, learn, and grow together.</strong>
      </p>
    </div>

    <div class="nt-footer-links">
      <h3>Quick Links</h3>
      <ul>
        <li><a href="profile.html"><i class="fa-solid fa-user"></i> Profile</a></li>
        <li><a href="bookmark.html"><i class="fa-solid fa-bookmark"></i> Bookmarks</a></li>
        <li><a href="achievements.html"><i class="fa-solid fa-medal"></i> Rewards</a></li>
        <li><a href="donate.html"><i class="fa-solid fa-hand-holding-heart"></i> Donate</a></li>
        <li><a href="about.html"><i class="fa-solid fa-circle-info"></i> About</a></li>
      </ul>
    </div>

    <div class="nt-footer-social">
      <h3>Connect with Us</h3>
      <div class="nt-social-icons">
        <a href="#" title="YouTube"><i class="fa-brands fa-youtube"></i></a>
        <a href="#" title="Instagram"><i class="fa-brands fa-instagram"></i></a>
        <a href="#" title="Telegram"><i class="fa-brands fa-telegram"></i></a>
        <a href="mailto:univora8@gmail.com" title="Email"><i class="fa-solid fa-envelope"></i></a>
      </div>
      <p class="nt-footer-mail">ðŸ“© univora8@gmail.com</p>
    </div>
  </div>

  <div class="nt-footer-bottom">
    <p>Â© 2024 <strong>Notora</strong>. All Rights Reserved. | A part of <strong>Univora</strong></p>
  </div>
</footer>

<script>
const API = "https://notoraadminbackend-1.onrender.com/api/userstats";
const token = localStorage.getItem("notoraToken");
const user = JSON.parse(localStorage.getItem("notoraUser") || "null");

const lockedNotice = document.getElementById("lockedNotice");
const content = document.getElementById("content");

if (!user || !token) {
  lockedNotice.style.display = "block";
  content.style.display = "none";
} else {
  fetchAchievements();
}

document.getElementById("refreshBtn")?.addEventListener("click", fetchAchievements);
document.getElementById("goStore")?.addEventListener("click", () => window.location.href = "/store.html");
document.getElementById("openStore")?.addEventListener("click", () => window.location.href = "/store.html");

async function fetchAchievements() {
  try {
    const res = await fetch(`${API}/${user._id}/achievements`, {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const data = await res.json();
    populate(data);
    content.style.display = "block";
    lockedNotice.style.display = "none";
  } catch (err) {
    console.error("âŒ Fetch Achievements Error:", err);
    content.style.display = "none";
    lockedNotice.style.display = "block";
  }
}

function populate(d) {
  document.getElementById("totalReads").textContent = d.totalReads || 0;
  document.getElementById("monthReads").textContent = d.monthReads || 0;
  document.getElementById("weekReads").textContent = d.weekReads || 0;
  document.getElementById("todayReads").textContent = d.todayReads || 0;
  document.getElementById("points").textContent = d.points || 0;

  const level = d.level || 0;
  document.getElementById("levelLabel").textContent = `Lv ${level}`;
  document.getElementById("levelDesc").textContent = getLevelName(level);

  const pct = Math.min(100, computeProgressPct(d.totalReads || 0));
  document.getElementById("levelProgress").style.width = pct + "%";

  document.getElementById("lastActive").textContent = d.lastActive
    ? new Date(d.lastActive).toLocaleString()
    : "Never";

  const evContainer = document.getElementById("events");
  evContainer.innerHTML = "";
  (d.recent || []).forEach((e) => {
    const div = document.createElement("div");
    div.className = "event";
    // const points =
    //   e.type === "read" ? "+1NT" :
    //   e.type === "share" ? "+2NT" :
    //   e.type === "donate" ? "+5NT" : "+0NT";
    const points =
  e.type === "read" ? "+1NT" :
  e.type === "share" ? "+2NT" :
  e.type === "donate" ? "+5NT" :
  e.type === "admin_bonus" ? `+${e.points || 0}NT` :
  "+0NT";

    div.innerHTML = `
      <div>
         <div style="font-weight:600;color:#fff">${e.type === "admin_bonus" ? "DONATE" : e.type.toUpperCase()} <span style="color:#ff4141">(${points})</span></div>

        <div class="muted" style="font-size:0.85rem">${e.bookId ? (e.bookId.name || e.bookId) : ""}</div>
      </div>
      <div class="muted">${new Date(e.createdAt).toLocaleString()}</div>`;
    evContainer.appendChild(div);
  });
  if (!d.recent || d.recent.length === 0) {
    evContainer.innerHTML = `<p style="color:#777;text-align:center;">No recent activity yet.</p>`;
  }
}

function getLevelName(l) {
  switch (l) {
    case 0: return "Newbie";
    case 1: return "Reader I";
    case 2: return "Reader II";
    case 3: return "Bookworm";
    case 4: return "Avid Reader";
    case 5: return "Pro Reader";
    case 6: return "Master Reader";
    case 7: return "Legend";
    default: return "Max";
  }
}

function computeProgressPct(totalReads) {
  const thresholds = [0, 5, 15, 50, 80, 150, 300, 400, 500];
  let curIdx = thresholds.findIndex((t) => totalReads < t) - 1;
  if (curIdx < 0) curIdx = thresholds.length - 2;
  const cur = thresholds[curIdx] || 0;
  const next = thresholds[curIdx + 1] || (cur + 1);
  const pct = ((totalReads - cur) / (next - cur)) * 100;
  return Math.max(5, Math.round(pct));
}
</script>
  <script src="session.js"></script>

</body>
</html>

