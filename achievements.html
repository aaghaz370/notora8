<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Achievements | Notora</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f0f10; --card:#141414; --accent:#ff416c; --muted:#9aa0a6;
  }
  body{margin:0;font-family:Poppins,system-ui;background:linear-gradient(180deg,#070707 0%, #0f0f0f 100%);color:#fff;padding:18px;}
  .container{max-width:1100px;margin:0 auto;}
  .header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
  h1{margin:0;font-size:1.3rem;color:var(--accent)}
  .card-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:14px;margin-bottom:18px}
  .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.6);}
  .big-num{font-size:2rem;font-weight:700}
  .muted{color:var(--muted);font-size:0.9rem}
  .level-badge{display:flex;align-items:center;gap:8px;padding:8px;border-radius:10px;background:linear-gradient(90deg,rgba(255,65,108,0.06),transparent);border:1px solid rgba(255,65,108,0.06)}
  .progress{height:10px;background:#0b0b0b;border-radius:10px;overflow:hidden;margin-top:8px}
  .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#e50914);width:0%}
  .events{max-height:320px;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:8px}
  .event{display:flex;justify-content:space-between;gap:8px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02)}
  .locked{display:flex;align-items:center;justify-content:center;padding:40px;border-radius:12px;background:linear-gradient(180deg,rgba(255,65,108,0.04),transparent);border:1px dashed rgba(255,65,108,0.06)}
  .btn{background:linear-gradient(135deg,var(--accent),#e50914);padding:8px 12px;border-radius:8px;border:none;color:#fff;cursor:pointer}
  @media(min-width:900px){ .header h1{font-size:1.6rem} }
</style>
</head>
<body>
<div class="container" id="app">
  <div class="header">
    <h1>Achievements & Rewards</h1>
    <div>
      <button class="btn" id="goStore">Go to Store</button>
    </div>
  </div>

  <div id="lockedNotice" style="display:none" class="locked">
    <div>
      <div style="font-weight:700;font-size:1.1rem">Login to unlock achievements</div>
      <div class="muted" style="margin-top:6px">This page is personal â€” sign in to see your stats & points.</div>
    </div>
  </div>

  <div id="content" style="display:none">
    <div class="card-grid">
      <div class="card">
        <div class="muted">Total Books Read</div>
        <div class="big-num" id="totalReads">0</div>
        <div class="muted">This month / week / today</div>
        <div style="display:flex;gap:6px;margin-top:8px">
          <div class="card" style="padding:8px;background:rgba(255,255,255,0.02);min-width:80px">
            <div class="muted">Month</div><div id="monthReads" class="big-num" style="font-size:1.2rem">0</div>
          </div>
          <div class="card" style="padding:8px;background:rgba(255,255,255,0.02);min-width:80px">
            <div class="muted">Week</div><div id="weekReads" class="big-num" style="font-size:1.2rem">0</div>
          </div>
          <div class="card" style="padding:8px;background:rgba(255,255,255,0.02);min-width:80px">
            <div class="muted">Today</div><div id="todayReads" class="big-num" style="font-size:1.2rem">0</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="muted">Points</div>
        <div class="big-num" id="points">0</div>
        <div class="muted" style="margin-top:8px">Breakdown: read=+1, share=+2, donate=+5</div>
      </div>

      <div class="card">
        <div class="muted">Level</div>
        <div class="level-badge">
          <div style="font-size:1.3rem;font-weight:700" id="levelLabel">Lv 0</div>
          <div class="muted" id="levelDesc">Newbie</div>
        </div>
        <div class="progress" style="margin-top:8px"><i id="levelProgress"></i></div>
      </div>

      <div class="card">
        <div class="muted">Last Active</div>
        <div id="lastActive" class="muted">â€”</div>
        <div style="margin-top:12px"><button class="btn" id="refreshBtn">Refresh</button></div>
      </div>
    </div>

    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <div style="flex:1;min-width:320px" class="card">
        <div class="muted">Recent Activity</div>
        <div class="events" id="events"></div>
      </div>

      <div style="width:320px" class="card">
        <div class="muted">Store (Preview)</div>
        <div style="margin-top:10px">You can exchange points for items here. (Implementation: separate store endpoints)</div>
        <div style="margin-top:12px"><button class="btn" id="openStore">Open Store</button></div>
      </div>
    </div>
  </div>
</div>

<script>
const API = "https://notoraadminbackend-1.onrender.com/api/userstats";
const token = localStorage.getItem("notoraToken");
const user = JSON.parse(localStorage.getItem("notoraUser") || "null");

const lockedNotice = document.getElementById("lockedNotice");
const content = document.getElementById("content");

// ðŸ” If not logged in, show lock screen
if (!user || !token) {
  lockedNotice.style.display = "block";
  content.style.display = "none";
} else {
  fetchAchievements();
}

// ðŸ”„ Buttons
document.getElementById("refreshBtn")?.addEventListener("click", fetchAchievements);
document.getElementById("goStore")?.addEventListener("click", () => window.location.href = "/store.html");
document.getElementById("openStore")?.addEventListener("click", () => window.location.href = "/store.html");

// ======================================================
// ðŸ”¹ Fetch Achievements
// ======================================================
async function fetchAchievements() {
  try {
    console.log("Fetching achievements for user:", user?._id);
    const res = await fetch(`${API}/${user._id}/achievements`, {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
    });

    if (!res.ok) {
      console.warn("Achievements response not OK:", res.status);
      if (res.status === 401 || res.status === 403) {
        alert("Session expired. Please log in again.");
        localStorage.removeItem("notoraUser");
        localStorage.removeItem("notoraToken");
        window.location.href = "profile.html";
        return;
      }
      throw new Error("Failed to fetch achievements");
    }

    const data = await res.json();
    console.log("âœ… Achievements data:", data);

    populate(data);
    content.style.display = "block";
    lockedNotice.style.display = "none";
  } catch (err) {
    console.error("âŒ Fetch Achievements Error:", err);
    content.style.display = "none";
    lockedNotice.style.display = "block";
    alert("Unable to load achievements. Try logging in again.");
  }
}

// ======================================================
// ðŸŽ¯ Populate Achievements Data into UI
// ======================================================
function populate(d) {
  document.getElementById("totalReads").textContent = d.totalReads || 0;
  document.getElementById("monthReads").textContent = d.monthReads || 0;
  document.getElementById("weekReads").textContent = d.weekReads || 0;
  document.getElementById("todayReads").textContent = d.todayReads || 0;
  document.getElementById("points").textContent = d.points || 0;

  const level = d.level || 0;
  document.getElementById("levelLabel").textContent = `Lv ${level}`;
  document.getElementById("levelDesc").textContent = getLevelName(level);

  // progress bar (simple: points % to next level)
  const pct = Math.min(100, computeProgressPct(d.totalReads || 0));
  const progressBar = document.getElementById("levelProgress");
  if (progressBar) {
    progressBar.style.width = pct + "%";
    progressBar.style.transition = "width 0.6s ease-in-out";
  }

  document.getElementById("lastActive").textContent = d.lastActive
    ? new Date(d.lastActive).toLocaleString()
    : "Never";

  // Recent Events List
  const evContainer = document.getElementById("events");
  if (evContainer) {
    evContainer.innerHTML = "";
    (d.recent || []).forEach((e) => {
      const div = document.createElement("div");
      div.className = "event";
      div.innerHTML = `
        <div>
          <div style="font-weight:600;color:#fff">${e.type.toUpperCase()}</div>
          <div class="muted" style="font-size:0.85rem;color:#bbb">
            ${e.bookId ? (e.bookId.name || e.bookId) : ""}
          </div>
        </div>
        <div class="muted" style="color:#999">${new Date(e.createdAt).toLocaleString()}</div>
      `;
      evContainer.appendChild(div);
    });

    if (!d.recent || d.recent.length === 0) {
      evContainer.innerHTML = `<p style="color:#777;text-align:center;">No recent activity yet.</p>`;
    }
  }
}

// ======================================================
// ðŸ… Helper: Level Name
// ======================================================
function getLevelName(l) {
  switch (l) {
    case 0: return "Newbie";
    case 1: return "Reader I";
    case 2: return "Reader II";
    case 3: return "Bookworm";
    case 4: return "Avid Reader";
    case 5: return "Pro Reader";
    case 6: return "Master Reader";
    case 7: return "Legend";
    default: return "Max";
  }
}

// ======================================================
// ðŸ“ˆ Helper: Level Progress Percent
// ======================================================
function computeProgressPct(totalReads) {
  // thresholds for level transitions
  const thresholds = [0, 5, 15, 50, 80, 150, 300, 400, 500];
  let curIdx = thresholds.findIndex((t) => totalReads < t) - 1;
  if (curIdx < 0) curIdx = thresholds.length - 2;
  const cur = thresholds[curIdx] || 0;
  const next = thresholds[curIdx + 1] || (cur + 1);
  const pct = ((totalReads - cur) / (next - cur)) * 100;
  return Math.max(5, Math.round(pct));
}
</script>

</body>
</html>
