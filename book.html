<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Book Details - Notora</title>
  <link rel="icon" href="images/logo.png" />
  <script src="https://kit.fontawesome.com/1c020da525.js" crossorigin="anonymous"></script>

  <style>
    /* ðŸ”¹ Styling same as before */
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: radial-gradient(circle at top, #111 0%, #000 100%);
      color: #fff;
      overflow-x: hidden;
    }
    header {
      display: flex; align-items: center; justify-content: center;
      position: relative; padding: 1rem 2rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(12px);
    }
    .back-arrow { position:absolute; left:20px; font-size:1.6rem; color:#fff; cursor:pointer; transition:transform .3s; }
    .back-arrow:hover { transform:translateX(-5px); }
    header h1 { font-size:1.6rem; text-align:center; letter-spacing:1px; }

    .pdf-container {
      margin:2rem auto 1rem; width:90%; max-width:900px;
      background:rgba(255,255,255,0.05); border-radius:15px; padding:1rem;
      box-shadow:0 0 30px rgba(255,0,0,0.12);
    }
    iframe { width:100%; height:500px; border:none; border-radius:10px; }

    .bookmark-btn {
      width:100%; background:linear-gradient(90deg,#ff4b2b,#ff416c);
      color:#fff; border:none; padding:0.8rem; font-size:1rem;
      border-radius:8px; cursor:pointer; margin-top:0.8rem;
      transition:all .3s ease; box-sizing:border-box;
    }
    .bookmark-btn:hover { transform:scale(1.02); }

    .book-meta {
      width:90%; max-width:900px; margin:1.5rem auto;
      background:rgba(255,255,255,0.03); padding:1.5rem;
      border-radius:12px; text-align:center;
    }

    .suggestions {
      margin:2.5rem auto 1.5rem; width:90%; max-width:1100px;
    }
    .suggestion-grid {
      display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap:1rem;
    }
    .suggestion-card {
      background:rgba(255,255,255,0.03); border-radius:10px;
      text-align:center; padding:0.5rem; transition:transform .35s;
      cursor:pointer;
    }
    .suggestion-card img { width:100%; height:170px; object-fit:cover; border-radius:8px; }
    .suggestion-card:hover { transform:scale(1.05); }

    /* Comments */
    .comments-wrapper {
      width:90%; max-width:900px; margin:1.5rem auto 3rem;
      background:rgba(255,255,255,0.03); border-radius:12px; padding:1rem;
    }
    .comment-form textarea, .comment-form input {
      width:100%; padding:10px; border-radius:8px; border:none;
      background:#0f0f0f; color:#fff; margin-top:8px;
    }
    .comment-form button {
      margin-top:8px; padding:8px 16px; background:#e50914; border:none;
      color:white; border-radius:8px; cursor:pointer;
    }
    .comment-card {
      background:rgba(0,0,0,0.4); padding:10px; border-radius:8px; margin-bottom:10px;
    }
  </style>
</head>

<body>
  <header>
    <i class="fa-solid fa-arrow-left back-arrow" onclick="window.history.back()"></i>
    <h1 id="bookName">Book</h1>
  </header>

  <div class="pdf-container">
    <iframe id="bookPdf" title="Book PDF"></iframe>
  </div>

  <div style="width:90%;max-width:900px;margin:0.8rem auto;">
    <button class="bookmark-btn" id="fullscreenBtn"> <i class="fa-solid fa-expand"></i> Fullscreen</button>
    <button class="bookmark-btn" id="bookmarkBtn"><i class="fa-solid fa-bookmark"></i> Add to Bookmarks</button>
  </div>

  <section class="book-meta">
    <p><strong>Author:</strong> <span id="bookAuthor"></span></p>
    <p><strong>Genre:</strong> <span id="bookGenre"></span></p>
    <p class="rating" id="bookRating"></p>
  </section>

  <div class="comments-wrapper">
    <h3>Comments</h3>
    <div class="comment-form">
      <input type="text" id="commentName" placeholder="Your name" />
      <textarea id="commentText" placeholder="Write a comment..."></textarea>
      <button id="postCommentBtn">Post</button>
    </div>
    <div id="commentsList">Loading comments...</div>
  </div>

  <section class="suggestions">
    <h3>Similar Books You May Like</h3>
    <div class="suggestion-grid" id="suggestionGrid"></div>
  </section>

<script>
const BACKEND_BASE = "https://notorabackend-c2yq.onrender.com";

const BOOKS_API = `${BACKEND_BASE}/api/books`;
const COMMENTS_API = `${BACKEND_BASE}/api/comments`;

const book = JSON.parse(localStorage.getItem("selectedBook") || "null");
if (!book) {
  alert("No book selected.");
  window.location.href = "index.html";
} else {
  document.getElementById('bookName').textContent = book.name;
  document.getElementById('bookAuthor').textContent = book.author;
  document.getElementById('bookGenre').textContent = book.genre;
  document.getElementById('bookRating').textContent = book.rating ? 'â­ ' + book.rating : '';
  document.getElementById('bookPdf').src = book.pdfUrl || "";
}

/* -------- Suggestion System -------- */
async function loadSuggestionsFromBackend() {
  try {
    const genre = encodeURIComponent(book.genre || "");
    const res = await fetch(`${BOOKS_API}?genre=${genre}`);
    const data = await res.json();
    let suggestions = data.filter(b => b._id !== book._id).slice(0,6);
    if (suggestions.length < 4) {
      const res2 = await fetch(BOOKS_API);
      const all = await res2.json();
      const randomFill = all.sort(()=>0.5-Math.random()).slice(0,6-suggestions.length);
      suggestions = [...suggestions, ...randomFill];
    }
    renderSuggestions(suggestions);
  } catch (e) {
    console.error(e);
  }
}

function renderSuggestions(list){
  const grid = document.getElementById('suggestionGrid');
  grid.innerHTML = "";
  if (!list.length) { grid.innerHTML = "<p>No suggestions available.</p>"; return; }
  list.forEach(b=>{
    const el=document.createElement('div');
    el.className="suggestion-card";
    el.innerHTML=`<img src="${b.thumbnail}" alt="${b.name}"><p>${b.name}</p>`;
    el.onclick=()=>{localStorage.setItem("selectedBook",JSON.stringify(b));window.location.reload();}
    grid.appendChild(el);
  });
}

/* -------- Comments -------- */
async function loadComments(){
  const res = await fetch(`${COMMENTS_API}/${book._id}`);
  const data = await res.json();
  const list = document.getElementById('commentsList');
  list.innerHTML = "";
  if (!data.length) { list.innerHTML="<p>No comments yet.</p>"; return; }
  data.forEach(c=>{
    const div=document.createElement('div');
    div.className="comment-card";
    div.innerHTML=`<strong>${c.name}</strong><p>${c.text}</p>`;
    list.appendChild(div);
  });
}

/* -------- Post Comment -------- */
document.getElementById('postCommentBtn').addEventListener('click', async()=>{
  const name=document.getElementById('commentName').value.trim();
  const text=document.getElementById('commentText').value.trim();
  if(!name||!text)return alert("Enter name and comment");
  await fetch(COMMENTS_API,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({bookId:book._id,name,text})
  });
  document.getElementById('commentText').value="";
  loadComments();
});

/* -------- Init -------- */
loadSuggestionsFromBackend();
loadComments();
</script>
</body>
</html>


